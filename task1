#include <iostream>
#include <fstream>
#include <string>
#include <cmath>
#include <Windows.h>

using namespace std;

class ErrorRange
{
    string str = "ErrorRange";
public:
    double rd;
    string file;
    ErrorRange(double d, string f = "") : rd(d), file(f) {}
    void Message()
    {
        cout << "ErrorRange: x = " << rd << " виходить за межі для " << file << endl;
    }
};

class ErrorNoFile
{
    string str = "ErrorNoFile";
public:
    string filename;
    ErrorNoFile(string s) : filename(s) {}
    void Message()
    {
        cout << "ErrorNoFile: файл " << filename << " не знайдено" << endl;
    }
};

class ErrorCalc
{
    string str = "ErrorCalc";
public:
    double val;
    ErrorCalc(double v) : val(v) {}
    void Message()
    {
        cout << "ErrorCalc: помилка при значенні " << val << endl;
    }
};
string dat3_text[100]; double dat3_value[100]; int dat3_count = 0;

void loadDat3()
{
    ifstream f("dat3.dat");
    if (!f)
    {
        cerr << "Помилка: файл dat3.dat не знайдено! Вихід з програми." << endl;
        exit(1);
    }
    dat3_count = 0;
    while (f >> dat3_text[dat3_count] >> dat3_value[dat3_count])
        dat3_count++;
    f.close();
}

double Tbl_U(double x) throw (ErrorRange, ErrorNoFile)
{
    if (x > 5 || x < -5) throw ErrorRange(x, "dat1.dat");

    ifstream is("dat1.dat");
    if (!is) throw ErrorNoFile("dat1.dat");

    double xi, yi, xi1, yi1, y = 0;
    is >> xi1 >> yi1;

    if (xi1 == x) y = yi1;
    else
    {
        while (!is.eof())
        {
            xi = xi1; yi = yi1;
            is >> xi1 >> yi1;
            if (xi <= x && x <= xi1)
            {
                y = yi + (yi1 - yi) * (x - xi) / (xi1 - xi);
                break;
            }
            if (xi1 == x) { y = yi1; break; }
        }
    }
    is.close();
    return y;
}

double Tbl_T(double x) throw (ErrorRange, ErrorNoFile)
{
    if (x > 10 || x < -10) throw ErrorRange(x, "dat2.dat");

    ifstream is("dat2.dat");
    if (!is) throw ErrorNoFile("dat2.dat");

    double xi, yi, xi1, yi1, y = 0;
    is >> xi1 >> yi1;

    if (xi1 == x) y = yi1;
    else
    {
        while (!is.eof())
        {
            xi = xi1; yi = yi1;
            is >> xi1 >> yi1;
            if (xi <= x && x <= xi1)
            {
                y = yi + (yi1 - yi) * (x - xi) / (xi1 - xi);
                break;
            }
            if (xi1 == x) { y = yi1; break; }
        }
    }
    is.close();
    return y;
}

double U1(double x)
{
    return atan(asin(sin(3 * x)));
}

double T1(double x)
{
    return atan(acos(sin(2 * x)));
}

double Qqn1(double x, double y, double z)
{
    return x / U1(x) + y * T1(y) - U1(z) * T1(z);
}

double Qnk1(double x, double y)
{
    return 1.1 * Qqn1(x, y, x + y) - 0.9 * Qqn1(y, x, x - y);
}

double Rnk_A2(double x, double y)
{
    double q1 = Qnk1(x, y);
    double q2 = Qnk1(y, x);
    return x * q1 + y * q2 - 0.03 * q1 * q2;
}

double func_A2(double x, double y, double z)
{
    double r1 = Rnk_A2(x, y);
    return r1 + Rnk_A2(y, z) * r1;
}

double Qqn2(double x, double y, double z)
{
    return x / U1(x) + y * T1(y) - 0.9 * U1(z) * T1(z);
}

double Qnk2(double x, double y)
{
    return 1.3 * Qqn2(x, y, x) - 0.7 * Qqn2(y, x, x);
}

double func_A3(double x, double y, double z)
{
    double q1 = Qnk2(x, y);
    double q2 = Qnk2(y, x);
    return 1.75 * x * q1 + 1.25 * y * q2 - 1.5 * q1 * q2;
}

double Qqn(double x, double y, double z) throw (ErrorRange, ErrorNoFile)
{
    return x / Tbl_U(x) + y * Tbl_T(y) - Tbl_U(z) * Tbl_T(z);
}

double Qnk(double x, double y) throw (ErrorRange, ErrorNoFile)
{
    return Qqn(x, y, x + y) - Qqn(y, x, x - y);
}

double Rnk(double x, double y) throw (ErrorRange, ErrorNoFile)
{
    return x * Qnk(x, y) + y * Qnk(y, x);
}

double func_A1(double x, double y, double z) throw (ErrorRange, ErrorNoFile)
{
    double r_val = Rnk(x, y);
    return r_val + Rnk(y, z) * r_val;
}

double Gtext(string t)
{
    for (int i = 0; i < dat3_count; i++)
        if (dat3_text[i] == t)
            return dat3_value[i];
    return 0;
}

double CText(double x, string text)
{
    if (x > 0)
        return Gtext(text) + x;
    else if (text == "")
        return Gtext("set") + Gtext("get") - x;
    else
        return Gtext("set") + Gtext(text);
}

double Max4(double a, double b, double c, double d)
{
    double m = a;
    if (b > m) m = b;
    if (c > m) m = c;
    if (d > m) m = d;
    return m;
}

double Y(double x) throw (ErrorCalc)
{
    double inner = 100 - x * x;
    if (inner < 0) throw ErrorCalc(x);

    double val = x * sqrt(inner);
    if (val < 1) throw ErrorCalc(x);

    return log(val);
}

double Yrr(double f, double r) throw (ErrorCalc)
{
    return Y(f) * r + 0.5 * Y(r);
}

double Trr(double f, double r) throw (ErrorCalc)
{
    double v = 4 * f * f - r;
    if (v < 0) throw ErrorCalc(f);

    return sqrt(v) + 0.5 * Yrr(r, f);
}

double Rrr(double f, double r) throw (ErrorCalc)
{
    return f * Trr(f, r) + r * Trr(f, 2 * f);
}

int main()
{
    SetConsoleOutputCP(1251);
    SetConsoleCP(1251);

    loadDat3();

    double x, y, z;
    string text;

    cout << "Введiть x, y, z: ";
    cin >> x >> y >> z;
    cin.ignore();
    cout << "Введiть text: ";
    getline(cin, text);

    double r = 0;
    int alg_used = 1;

    try
    {
        r = func_A1(x, y, z);
        alg_used = 1;
    }
    catch (ErrorNoFile& e)
    {
        e.Message();
        if (e.filename == "dat2.dat")
        {
            cout << "Перехiд на Алгоритм 3" << endl;
            r = func_A3(x, y, z);
            alg_used = 3;
        }
        else
        {
            cout << "Перехiд на Алгоритм 2" << endl;
            r = func_A2(x, y, z);
            alg_used = 2;
        }
    }
    catch (ErrorRange& e)
    {
        e.Message();
        cout << "Перехiд на Алгоритм 2" << endl;
        r = func_A2(x, y, z);
        alg_used = 2;
    }

    double f = CText(Max4(x, y, x + z, y + z), text);

    double k = 0;
    try
    {
        k = Rrr(f, r);
    }
    catch (ErrorCalc& e)
    {
        e.Message();
        k = 0;
    }

    double variant = 0.8973 * r + 0.1027 * k;

    cout << "\nРезультат виконання програми:" << endl;
    cout << "Алгоритм: " << alg_used << endl;
    cout << "r = " << r << endl;
    cout << "f = " << f << endl;
    cout << "k = " << k << endl;
    cout << "Variant(r,k) = " << variant << endl;

    return 0;
}
